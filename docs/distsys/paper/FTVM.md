---
title: 容错虚拟机
createTime: 2025/12/08 20:07:54
permalink: /distsys/cv7rbt64/
---

### 介绍

最常见的实现容错服务器的策略，就是主从备份的方法。当主服务器崩溃的时候，备份服务器可以接替主服务器的工作。但是备份服务器要和主服务器保持一样的状态，需要同步CPU,内存，磁盘,I/O等设备的数据，需要消耗大量的带宽。

另一种不同的想法实现上面的策略，使用较少的带宽，让备份与主服务器保持同步。这种想法的模型可以看做一个确定的状态机，两台机器从相同的初始化状态开始，按顺序接收并执行相同的操作，就可以实现同步了。
尽管有效操作是不确定的，这需要其他额外的同步机制。

想要在实际的物理机器上实现上面的确定性状态机，是十分困难的，因此只能在Hypervisor上运行虚拟机（virtual machine）来实现。这里可以将虚拟机视为一个定义明确的状态机。

记录主虚拟机的执行并确保备虚拟机完全相同地执行的基础技术被称为确定性重放（deterministic replay）。

目前只能在单处理器的虚拟机，因为多处理器中访问共享内存是不确定性的操作。

我们仅尝试处理“故障-停止”（fail-stop）类型的故障，这类服务器故障能够在故障服务器导致错误的外部可见行为之前被检测到。

论文剩下的部分将按下面的顺序来介绍，首先，描述最重要的协议的设计与细节，该协议保证了如果副节点接管发生故障的主服务器，没有数据丢失。然后我们讨论一些必须处理的实际问题的细节。接着我们会描述实现容错虚拟机中出现的若干设计问题。

### 基础设计

![center](/distsys/ftvm/arch.png){ style="display: block; margin-left: auto; margin-right: auto;" }

图片中展示了设计的基本架构，主虚拟机和备虚拟机分别运行在两个不同的物理机器上。两台虚拟机保持同步并执行相同的操作，尽管存在微小的时间延迟，我们称为虚拟锁步状态。
虚拟磁盘是主虚拟机和备虚拟机共享的，主机和备份机机都可以访问这些磁盘进行输入输出。

所有主机的操作都会通过日志通道（LogChannel）进行同步,发送到备份机上。同时还会有传输其他额外的信息来保证同步。服务器负载，主要的输入流量来自网络和硬盘，
备份机的输出会被Hypervisor丢弃，因此只有主机输入数据才会发送给客户端。

使用心跳机制来检测主机和备用机是否存活或者任务失败。

#### 确定性重放的设计

确定性的事件有一系列的输入，即将到来的网络包，磁盘的读写，键盘鼠标的输入。

不确定性的事件有虚拟机的中断，和处理器的时钟计数。